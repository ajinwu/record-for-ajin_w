# redis持久化
1. 快照持久化(放在dbfilename)
   1. 发送bgsave命令来创建快照, redis会fork一个子线程负责写入磁盘
   2. 发送save命令创建快照, 快照创建完毕以后不响应任何命令, 不常用(但是不fork线程)
   3. 如果用户设置了save选项, 比如save 60 1000, redis会在最近一次创建快照算起, 在60s内有1000次写入就会自动出发bgsave命令, 设置多个save选项, 满足任意一个都会出发bgsave
   4. 收到shutdown信号量, 会执行save命令, 阻塞所有客户端, save后关闭服务器
   5. 两个服务器互联, 并发送sync命令

2. AOF持久化, 执行命令写入文件
   1. AOF有其局限性, AOF文件体积会不断增长, 恢复时间也会极长
   2. 可以想redis发送bgrewriteaof命令来减少冗余重写文件, 也是fork子线程进行操作
   3. 可以设置auto-aof-rewrite-percentage来自动执行重写

3. 主从服务器
   1. 启动redis服务器的时候指定slaveof host port选项的配置文件
   2. 对正在运行的服务器, 使用slaveof no one终止复制操作, 不在接受主服务器的数据更新
   3. 也可以通过slaveof host port来开始复制一个新的主服务器

主从服务器同步步骤(不支持多主)

步骤|主服务器操作|从服务器操作
--|--|---
1|等待命令进入|连接(或重连)主服务器, 发送sync命令
2|开始执行bgsave, 使用缓存区记录bgsave之后执行的所有写命令|根据配置来决定是继续使用现有数据(如果有)来处理客户端请求,还是发送请求的客户端返回错误
3|bgsave执行完毕, 向从服务器发送快照文件, 并在发送期间继续使用缓冲区记录写命令|丢弃所有旧数据, 开始载入快照
4|快照发送完毕, 开始向从服务器发送存储在缓冲区的写命令|完成快照解释操作, 接受命令请求
5|缓冲区写命令发送完毕, 开始同步操作|执行主服务器发来的缓冲去写命令,开始同步写命令

使用主从链来减少主服务器的压力

redis持久化方案:多个从服务器, 每个从服务器设置appendonly yes和appendfsync everysec

检查硬盘写入:检查info命令的结果中aof_pending_bio_fsync是否均为o, 为0表示全部保存

故障处理
1. 验证快照文件和aof文件`redis-check-rdb`,`redis-check-aof`

更换主服务器
1.
   1. 从服务器发送save命令
   2. 启动另一个将要成为主服务器的redis
   3. 从服务器连接主服务器
2. 从服务器升级为主服务器
